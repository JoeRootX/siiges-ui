import { Grid } from '@mui/material';
import {
  getData, Input, Select, Subtitle,
} from '@siiges-ui/shared';
import React, { useEffect, useState } from 'react';
import PropTypes from 'prop-types';

const apiKey = process.env.NEXT_PUBLIC_API_KEY;
const domain = process.env.NEXT_PUBLIC_URL;

export default function DatosInstitucion({ form, handleOnChange, estados }) {
  const [tipoInstituciones, setTipoInstituciones] = useState([]);
  const [programas, setProgramas] = useState([]);
  const [instituciones, setInstituciones] = useState([]);
  const [grados, setGrados] = useState([]);
  const [tipoInstitucionId, setTipoInstitucionId] = useState(form.institucionDestino?.tipoInstitucionId || '');

  useEffect(() => {
    const fetchTipoInstituciones = async () => {
      try {
        const response = await fetch(`${domain}/api/v1/public/instituciones/tipoInstituciones`, {
          headers: {
            api_key: apiKey,
            'Content-Type': 'application/json',
          },
        });
        const data = await response.json();
        setTipoInstituciones(data.data);
      } catch (error) {
        console.error('Error fetching tipo de instituciones:', error);
      }
    };

    setGrados(getData({ endpoint: '/public/grados/' }));
    fetchTipoInstituciones();
  }, []);

  const fetchInstituciones = async () => {
    try {
      const response = await fetch(
        `${domain}/api/v1/public/instituciones?tipoInstitucionId=${tipoInstitucionId}`,
        {
          headers: {
            api_key: apiKey,
            'Content-Type': 'application/json',
          },
        },
      );
      const data = await response.json();
      setInstituciones(data.data);
    } catch (error) {
      console.error('Error fetching instituciones:', error);
    }
  };

  const fetchProgramas = async (acuerdoRvoe) => {
    try {
      const response = await fetch(
        `${domain}/api/v1/public/programas?acuerdoRvoe=${acuerdoRvoe}`,
        {
          headers: {
            api_key: apiKey,
            'Content-Type': 'application/json',
          },
        },
      );
      const data = await response.json();
      setProgramas(data.data);
    } catch (error) {
      console.error('Error fetching Programas:', error);
    }
  };

  useEffect(() => {
    if (tipoInstitucionId === 1) {
      fetchInstituciones();
    }
  }, [tipoInstitucionId]);

  const handleTipoInstitucionChange = (event) => {
    const selectedTipoInstitucionId = event.target.value;
    setTipoInstitucionId(selectedTipoInstitucionId);
    handleOnChange(event, ['interesado', 'institucionDestino']);
  };

  const handleRvoeOnBlur = (event) => {
    const acuerdoRvoe = event.target.value;
    if (tipoInstitucionId === 1) {
      fetchProgramas(acuerdoRvoe);
    }
    handleOnChange(event, ['interesado', 'institucionDestino']);
  };

  return (
    <Grid container spacing={1}>
      <Grid item xs={12}>
        <Subtitle>Datos de la Institución de procedencia</Subtitle>
      </Grid>
      <Grid item xs={9}>
        <Input
          id="nombreInstitucion"
          label="Nombre de la Institución"
          name="nombre"
          value={form.institucionProcedencia?.nombre || ''}
          onChange={(e) => handleOnChange(e, ['interesado', 'institucionProcedencia'])}
        />
      </Grid>
      <Grid item xs={3}>
        <Select
          title="Grado Academico procedente"
          options={grados}
          name="gradoAcademicoProcedente"
          value={form.institucionProcedencia?.gradoAcademicoProcedente || ''}
          onChange={(e) => handleOnChange(e, ['interesado', 'institucionProcedencia'])}
        />
      </Grid>
      <Grid item xs={9}>
        <Input
          id="nombreCarrera"
          label="Nombre de la Carrera"
          name="nombreCarrera"
          value={form.institucionProcedencia?.nombreCarrera || ''}
          onChange={(e) => handleOnChange(e, ['interesado', 'institucionProcedencia'])}
        />
      </Grid>
      <Grid item xs={3}>
        <Select
          title="Pais"
          options={estados}
          name="paisId"
          value={form.institucionProcedencia?.paisId || ''}
          onChange={(e) => handleOnChange(e, ['interesado', 'institucionProcedencia'])}
        />
      </Grid>
      {form.tipoTramiteId === 1 && (
      <>
        <Grid item xs={12}>
          <Subtitle>Datos de la Institución de destino</Subtitle>
        </Grid>
        <Grid item xs={3}>
          <Select
            title="Tipo de Institución"
            name="tipoInstitucionId"
            options={tipoInstituciones}
            value={tipoInstitucionId}
            onChange={handleTipoInstitucionChange}
          />
        </Grid>
        <Grid item xs={9}>
          {tipoInstitucionId === 1 ? (
            <Select
              title="Instituciones"
              options={instituciones}
              name="programaId"
              value={form.institucionDestino?.programaId || ''}
              onChange={(e) => handleOnChange(e, ['interesado', 'institucionDestino'])}
            />
          ) : (
            <Input
              id="institucionNombre"
              label="Instituciones de Educación Superior"
              name="nombre"
              value={form.institucionDestino?.nombre || ''}
              onChange={(e) => handleOnChange(e, ['interesado', 'institucionDestino'])}
            />
          )}
        </Grid>
        <Grid item xs={3}>
          <Input
            id="rvoe"
            label="RVOE"
            name="acuerdoRvoe"
            value={form.institucionDestino?.acuerdoRvoe || ''}
            onblur={handleRvoeOnBlur}
          />
        </Grid>
        <Grid item xs={9}>
          <Input
            id="nombreCarreraDestino"
            label="Nombre de la Carrera (Destino)"
            name="nombreCarrera"
            value={programas.nombre || ''}
            onChange={(e) => handleOnChange(e, ['interesado', 'institucionDestino'])}
            disabled={tipoInstitucionId === 1}
          />
        </Grid>
      </>
      )}
    </Grid>
  );
}

DatosInstitucion.propTypes = {
  form: PropTypes.shape({
    tipoTramiteId: PropTypes.number,
    institucionProcedencia: PropTypes.shape({
      nombre: PropTypes.string,
      paisId: PropTypes.string,
      nombreCarrera: PropTypes.string,
      gradoAcademicoProcedente: PropTypes.string,
    }),
    institucionDestino: PropTypes.shape({
      tipoInstitucionId: PropTypes.oneOfType([PropTypes.string, PropTypes.number]),
      programaId: PropTypes.oneOfType([PropTypes.string, PropTypes.number]),
      nombre: PropTypes.string,
      acuerdoRvoe: PropTypes.string,
      nombreCarrera: PropTypes.string,
    }),
  }).isRequired,
  handleOnChange: PropTypes.func.isRequired,
  estados: PropTypes.arrayOf(
    PropTypes.shape({
      id: PropTypes.oneOfType([PropTypes.string, PropTypes.number]).isRequired,
      nombre: PropTypes.string.isRequired,
    }),
  ).isRequired,
};
